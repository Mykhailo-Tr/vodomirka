{% extends "base.html" %}

{% block title %}{{ competition.name }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1><i class="bi bi-trophy me-2"></i>{{ competition.name }}</h1>
        <div class="d-flex gap-2 align-items-center">
          <span class="badge bg-{{ 'success' if competition.status == 'active' else 'secondary' if competition.status == 'draft' else 'primary' }}">
            {{ competition.status.title() }}
          </span>
          <small class="text-muted">
            {{ exercise.name }} • {{ athletes|length }} athletes
          </small>
        </div>
      </div>
      <div class="btn-group">
        {% if competition.status == 'draft' %}
          <button class="btn btn-success" onclick="startCompetition()">
            <i class="bi bi-play-circle me-1"></i> Start Competition
          </button>
        {% elif competition.status == 'active' %}
          <button class="btn btn-warning" onclick="finishCompetition()" id="finishBtn" disabled>
            <i class="bi bi-stop-circle me-1"></i> Finish Competition
          </button>
        {% endif %}
        {% if competition.status != 'active' %}
          <button class="btn btn-outline-danger" onclick="deleteCompetition()">
            <i class="bi bi-trash me-1"></i> Delete
          </button>
        {% endif %}
        <a href="{{ url_for('competition.index') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i> Back
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Left Panel - Athletes List -->
  <div class="col-md-3">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-people me-2"></i>Athletes</h6>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush" id="athletesList">
          {% for athlete in athletes %}
            <div class="list-group-item list-group-item-action cursor-pointer athlete-item" 
                 data-athlete-id="{{ athlete.id }}"
                 onclick="selectAthlete({{ athlete.id }})">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">{{ athlete.athlete.full_name }}</h6>
                  <small class="text-muted">Score: {{ athlete.total_score }}</small>
                </div>
                <span class="badge bg-primary">{{ athlete.finished_series }}/{{ athlete.series_count }}</span>
              </div>
              <div class="mt-2">
                {% for series in athlete.series %}
                  <span class="badge bg-{{ 'success' if series.status == 'finished' else 'warning' if series.status == 'finished_early' else 'secondary' }} me-1">
                    S{{ series.series_number }}
                  </span>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Center Panel - Upload and Images -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="bi bi-camera me-2"></i>
          <span id="uploadTitle">Select Athlete to Start</span>
        </h6>
      </div>
      <div class="card-body" id="uploadSection">
        <div class="text-center text-muted py-5">
          <i class="bi bi-arrow-left-circle" style="font-size: 3rem;"></i>
          <p class="mt-3">Select an athlete from the left panel to start shooting</p>
        </div>
      </div>
    </div>
    
    <!-- Images List -->
    <div class="card mt-3" id="imagesCard" style="display: none;">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-images me-2"></i>Uploaded Images</h6>
      </div>
      <div class="card-body">
        <div id="imagesList" class="row">
          <!-- Images will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Right Panel - Statistics -->
  <div class="col-md-3">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Statistics</h6>
      </div>
      <div class="card-body">
        <div id="statsSection">
          <p class="text-muted text-center">Select an athlete to view statistics</p>
        </div>
      </div>
    </div>
    
    <!-- Series Progress -->
    <div class="card mt-3" id="seriesCard" style="display: none;">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-list-ol me-2"></i>Series Progress</h6>
      </div>
      <div class="card-body">
        <div id="seriesList">
          <!-- Series will be loaded here -->
        </div>
      </div>
    </div>
    
    <!-- JSON Output -->
    <div class="card mt-3" id="jsonCard" style="display: none;">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-code-slash me-2"></i>JSON Output</h6>
      </div>
      <div class="card-body">
        <pre id="jsonOutput" class="small" style="max-height: 200px; overflow-y: auto;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Camera Capture</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <video id="cameraVideo" width="640" height="480" autoplay style="display: none;"></video>
        <canvas id="cameraCanvas" width="640" height="480" style="display: none;"></canvas>
        <div id="cameraPlaceholder" class="py-5">
          <i class="bi bi-camera" style="font-size: 3rem;"></i>
          <p class="mt-3">Click "Start Camera" to begin</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="startCameraBtn">Start Camera</button>
        <button type="button" class="btn btn-success" id="captureBtn" style="display: none;">Capture</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAthleteId = null;
let currentSeriesId = null;
let cameraStream = null;
let selectedAthleteData = null;

const competitionData = {{ competition|tojson }};
const athletesData = {{ athletes|tojson }};
const exerciseData = {{ exercise|tojson }};

function selectAthlete(athleteId) {
  // Update UI selection
  document.querySelectorAll('.athlete-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-athlete-id="${athleteId}"]`).classList.add('active');
  
  currentAthleteId = athleteId;
  selectedAthleteData = athletesData.find(a => a.id == athleteId);
  
  // Find first active series
  const activeSeries = selectedAthleteData.series.find(s => s.status === 'active');
  
  if (activeSeries) {
    currentSeriesId = activeSeries.id;
    showUploadInterface(selectedAthleteData, activeSeries);
    loadSeriesImages(activeSeries.id);
  } else {
    showNoActiveSeries(selectedAthleteData);
  }
  
  updateStatistics(selectedAthleteData);
  updateSeriesList(selectedAthleteData);
}

function showUploadInterface(athlete, series) {
  const uploadSection = document.getElementById('uploadSection');
  const uploadTitle = document.getElementById('uploadTitle');
  
  uploadTitle.textContent = `${athlete.athlete.full_name} - Series ${series.series_number}`;
  
  uploadSection.innerHTML = `
    <div class="row">
      <div class="col-md-6 mb-3">
        <div class="d-grid">
          <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-upload me-2"></i>Upload from File
          </button>
          <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="d-grid">
          <button class="btn btn-success" onclick="openCamera()">
            <i class="bi bi-camera me-2"></i>Use Camera
          </button>
        </div>
      </div>
    </div>
    
    <div class="d-flex gap-2">
      <button class="btn btn-warning" onclick="finishSeries('early')" 
              ${competitionData.status !== 'active' ? 'disabled' : ''}>
        <i class="bi bi-stop-circle me-1"></i>Finish Series Early
      </button>
      <button class="btn btn-success" onclick="finishSeries('normal')" 
              ${competitionData.status !== 'active' ? 'disabled' : ''}>
        <i class="bi bi-check-circle me-1"></i>Finish Series
      </button>
    </div>
  `;
  
  document.getElementById('imagesCard').style.display = 'block';
}

function showNoActiveSeries(athlete) {
  const uploadSection = document.getElementById('uploadSection');
  const uploadTitle = document.getElementById('uploadTitle');
  
  uploadTitle.textContent = athlete.athlete.full_name;
  
  uploadSection.innerHTML = `
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle me-2"></i>
      No active series for this athlete. All series are finished.
    </div>
  `;
  
  document.getElementById('imagesCard').style.display = 'none';
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  uploadImage(file);
}

function uploadImage(file) {
  const formData = new FormData();
  formData.append('image', file);
  
  fetch(`/competition/series/${currentSeriesId}/upload`, {
    method: 'POST',
    body: formData
  })
  .then(async (response) => {
    const text = await response.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error(text || `HTTP ${response.status}`);
    }
    if (!response.ok) {
      throw new Error(data && data.error ? data.error : `HTTP ${response.status}`);
    }
    return data;
  })
  .then(data => {
    if (!data || !data.success) {
      alert('Error: ' + (data && data.error ? data.error : 'Upload failed'));
      return;
    }
    loadSeriesImages(currentSeriesId);
    updateStatistics(selectedAthleteData);
    updateJsonOutput(data);
  })
  .catch(error => {
    console.error('Error uploading image:', error);
    alert('Error uploading image: ' + (error && error.message ? error.message : error));
  });
}

function openCamera() {
  const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
  modal.show();
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      cameraStream = stream;
      const video = document.getElementById('cameraVideo');
      video.srcObject = stream;
      video.style.display = 'block';
      document.getElementById('cameraPlaceholder').style.display = 'none';
      document.getElementById('startCameraBtn').style.display = 'none';
      document.getElementById('captureBtn').style.display = 'inline-block';
    })
    .catch(error => {
      console.error('Error accessing camera:', error);
      alert('Error accessing camera');
    });
}

function capturePhoto() {
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('cameraCanvas');
  const context = canvas.getContext('2d');
  
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg');
  
  // Close modal and upload
  bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();
  stopCamera();

  const blob = (function dataUrlToBlob(url) {
    const parts = url.split(',');
    const mime = parts[0].match(/:(.*?);/)[1];
    const bstr = atob(parts[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], { type: mime });
  })(dataUrl);

  const formData = new FormData();
  formData.append('image', blob, `snapshot_${Date.now()}.jpg`);

  fetch(`/competition/series/${currentSeriesId}/upload`, {
    method: 'POST',
    body: formData
  })
  .then(async (response) => {
    const text = await response.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error(text || `HTTP ${response.status}`);
    }
    if (!response.ok) {
      throw new Error(data && data.error ? data.error : `HTTP ${response.status}`);
    }
    return data;
  })
  .then(data => {
    if (!data || !data.success) {
      alert('Error: ' + (data && data.error ? data.error : 'Upload failed'));
      return;
    }
    loadSeriesImages(currentSeriesId);
    updateStatistics(selectedAthleteData);
    updateJsonOutput(data);
  })
  .catch(error => {
    console.error('Error uploading image:', error);
    alert('Error uploading image: ' + (error && error.message ? error.message : error));
  });
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  
  const video = document.getElementById('cameraVideo');
  video.style.display = 'none';
  document.getElementById('cameraPlaceholder').style.display = 'block';
  document.getElementById('startCameraBtn').style.display = 'inline-block';
  document.getElementById('captureBtn').style.display = 'none';
}

function loadSeriesImages(seriesId) {
  fetch(`/competition/series/${seriesId}/images`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayImages(data.images);
      }
    })
    .catch(error => {
      console.error('Error loading images:', error);
    });
}

function displayImages(images) {
  const imagesList = document.getElementById('imagesList');
  
  if (images.length === 0) {
    imagesList.innerHTML = '<p class="text-muted text-center">No images uploaded yet</p>';
    return;
  }
  
  let html = '';
  images.forEach(image => {
    html += `
      <div class="col-md-6 mb-3">
        <div class="card">
          <img src="/${image.original_path}" class="card-img-top" style="height: 150px; object-fit: cover;">
          <div class="card-body p-2">
            <small class="text-muted">${image.filename}</small>
            <div class="d-flex justify-content-between align-items-center">
              <span class="badge bg-primary">${image.shots_count} shots</span>
              <span class="badge bg-success">${image.total_score} pts</span>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  imagesList.innerHTML = html;
}

function updateStatistics(athlete) {
  const statsSection = document.getElementById('statsSection');
  const finishedSeries = athlete.series.filter(s => s.status === 'finished' || s.status === 'finished_early');
  const totalShots = athlete.series.reduce((sum, s) => sum + s.shots_count, 0);
  const totalScore = athlete.total_score;
  const avgScore = totalShots > 0 ? (totalScore / totalShots).toFixed(1) : 0;
  
  statsSection.innerHTML = `
    <div class="mb-3">
      <h6>${athlete.athlete.full_name}</h6>
      <div class="progress mb-2">
        <div class="progress-bar" style="width: ${(finishedSeries.length / athlete.series_count) * 100}%"></div>
      </div>
      <small class="text-muted">${finishedSeries.length}/${athlete.series_count} series completed</small>
    </div>
    
    <div class="row text-center">
      <div class="col-6">
        <div class="border rounded p-2">
          <div class="fw-bold">${totalScore}</div>
          <small class="text-muted">Total Score</small>
        </div>
      </div>
      <div class="col-6">
        <div class="border rounded p-2">
          <div class="fw-bold">${avgScore}</div>
          <small class="text-muted">Avg/Shot</small>
        </div>
      </div>
    </div>
    
    <div class="mt-3">
      <small class="text-muted">
        <strong>Total Shots:</strong> ${totalShots}<br>
        <strong>Best Series:</strong> ${Math.max(...athlete.series.map(s => s.total_score))} pts
      </small>
    </div>
  `;
  
  document.getElementById('statsSection').parentElement.parentElement.style.display = 'block';
}

function updateSeriesList(athlete) {
  const seriesList = document.getElementById('seriesList');
  
  let html = '';
  athlete.series.forEach(series => {
    const statusClass = series.status === 'finished' ? 'success' : 
                        series.status === 'finished_early' ? 'warning' : 'secondary';
    const statusIcon = series.status === 'finished' ? 'check' : 
                       series.status === 'finished_early' ? 'stop' : 'clock';
    
    html += `
      <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
        <div>
          <strong>Series ${series.series_number}</strong>
          <div class="small text-muted">${series.shots_count} shots • ${series.total_score} pts</div>
        </div>
        <span class="badge bg-${statusClass}">
          <i class="bi bi-${statusIcon}"></i> ${series.status}
        </span>
      </div>
    `;
  });
  
  seriesList.innerHTML = html;
  document.getElementById('seriesCard').style.display = 'block';
}

function updateJsonOutput(data) {
  const jsonOutput = document.getElementById('jsonOutput');
  jsonOutput.textContent = JSON.stringify(data, null, 2);
  document.getElementById('jsonCard').style.display = 'block';
}

function finishSeries(type) {
  if (!confirm(`Are you sure you want to finish this series${type === 'early' ? ' early' : ''}?`)) {
    return;
  }
  
  fetch(`/competition/series/${currentSeriesId}/finish`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ type: type })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload(); // Reload to update all UI
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error finishing series:', error);
    alert('Error finishing series');
  });
}

function startCompetition() {
  if (!confirm('Are you sure you want to start this competition?')) {
    return;
  }
  
  fetch(`/competition/{{ competition.id }}/start`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error starting competition:', error);
    alert('Error starting competition');
  });
}

function finishCompetition() {
  if (!confirm('Are you sure you want to finish this competition?')) {
    return;
  }
  
  fetch(`/competition/{{ competition.id }}/finish`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error finishing competition:', error);
    alert('Error finishing competition');
  });
}

function deleteCompetition() {
  if (!confirm('Are you sure you want to delete this competition? This action cannot be undone.')) {
    return;
  }
  
  fetch(`/competition/{{ competition.id }}/delete`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = '{{ url_for("competition.index") }}';
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error deleting competition:', error);
    alert('Error deleting competition');
  });
}

// Camera modal event listeners
document.getElementById('startCameraBtn').addEventListener('click', startCamera);
document.getElementById('captureBtn').addEventListener('click', capturePhoto);

// Close camera when modal is hidden
document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function () {
  stopCamera();
});

// Check if competition can be finished
function checkCanFinish() {
  const finishBtn = document.getElementById('finishBtn');
  if (finishBtn) {
    fetch(`/competition/{{ competition.id }}/results`)
      .then(response => response.json())
      .then(data => {
        finishBtn.disabled = !data.competition.can_finish;
      });
  }
}

// Initialize
if (competitionData.status === 'active') {
  checkCanFinish();
}
</script>
{% endblock %}
